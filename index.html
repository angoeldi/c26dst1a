<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chatbot Onboarding Copy Study</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; max-width: 920px; margin: 26px auto; padding: 0 16px; line-height: 1.45; }
    h1 { font-size: 1.25rem; margin: 0 0 6px; }
    .muted { color: #555; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; margin: 14px 0; background: #fff; }
    .title { font-weight: 700; margin: 0 0 8px; }
    .row { display: flex; gap: 10px; align-items: center; }
    .btn { padding: 10px 14px; font-size: 1rem; cursor: pointer; }
    .btn:disabled { opacity: .55; cursor: not-allowed; }
    fieldset { border: 1px solid #ddd; border-radius: 12px; padding: 14px; margin: 14px 0; }
    legend { font-weight: 700; padding: 0 6px; }
    .options { display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 10px; }
    .error { color: #b00020; font-weight: 700; }
    .ok { color: #0a7a0a; font-weight: 700; }
    code { background: #f4f4f4; padding: 2px 6px; border-radius: 6px; }
    .chatShell { border: 1px solid #e2e2e2; border-radius: 14px; overflow: hidden; }
    .chatHeader { background: #fafafa; border-bottom: 1px solid #e8e8e8; padding: 12px 14px; display:flex; justify-content:space-between; align-items:center; }
    .chatHeader .name { font-weight: 800; }
    .chatHeader .sub { color:#666; font-size:.95em; }
    .banner { padding: 12px 14px; border-bottom: 1px solid #eee; background: #fcfcff; }
    .bannerTitle { font-weight: 800; margin: 0 0 6px; }
    .banner ul { margin: 8px 0 0 18px; }
    .messages { padding: 14px; background:#fff; min-height: 130px; }
    .bubble { max-width: 80%; padding: 10px 12px; border-radius: 14px; border: 1px solid #eee; background:#f7f7f7; margin-bottom: 10px; }
    .bubble.me { margin-left:auto; background:#eef5ff; border-color:#e1ecff; }
    .inputRow { display:flex; gap:10px; padding: 12px 14px; border-top:1px solid #eee; background:#fafafa; }
    .fakeInput { flex:1; border:1px solid #ddd; border-radius: 999px; padding: 10px 12px; color:#777; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; border:1px solid #ddd; background:#fff; font-size:.9em; color:#444; }
  </style>
</head>
<body>

<h1>Short survey</h1>
<p class="muted">Please read the on-screen information and answer a few questions.</p>

<div id="fatal" class="card" style="display:none;">
  <div class="title">Cannot start</div>
  <p id="fatalMsg" class="error"></p>
  <p class="muted">If you are on Prolific, return to Prolific and re-open the study link.</p>
</div>

<div id="consentCard" class="card">
  <div class="title">Consent</div>
  <p class="muted">
    This is a brief research survey. Your responses are stored with your Prolific participant ID for payment and de-duplication.
    You may stop at any time.
  </p>
  <label class="row">
    <input type="checkbox" id="consent" />
    <span>I consent to participate.</span>
  </label>
  <div style="margin-top:12px;">
    <button class="btn" id="startBtn" disabled>Continue</button>
  </div>
  <p id="setupNote" class="muted"></p>
</div>

<div id="stimulusStage" style="display:none;">
  <div class="card">
    <div class="title">Cora</div>

    <div class="chatShell" aria-label="Chat UI mock">
      <div class="chatHeader">
        <div>
          <div class="name">Cora</div>
          <div class="sub">AI assistant</div>
        </div>
        <span class="pill">Beta</span>
      </div>

      <!-- THIS BANNER IS THE MANIPULATION -->
      <div id="banner" class="banner"></div>

      <div class="messages">
        <div class="bubble">Hi — I’m Cora. What would you like to do today?</div>
        <div class="bubble me">Help me plan my week.</div>
        <div class="bubble">Sure. What are your top priorities?</div>
      </div>

      <div class="inputRow">
        <div class="fakeInput">Type a message…</div>
        <button class="btn" type="button" disabled>Send</button>
      </div>
    </div>

    <p class="muted" id="continueNote" style="margin-top:12px;"></p>
    <button class="btn" id="toQuestionsBtn" disabled>Answer questions</button>
  </div>
</div>

<div id="questionStage" style="display:none;">
  <form id="survey" class="card">
    <div class="title">Questions</div>
    <div id="qBox"></div>
    <button class="btn" id="submitBtn" type="submit">Submit</button>
    <p id="msg" class="muted"></p>
  </form>
</div>

<div id="done" class="card" style="display:none;">
  <div class="title">Done</div>
  <p class="ok">Your response has been recorded.</p>
  <p>Completion code: <code id="cc"></code></p>
  <p class="muted">
    If you are not redirected automatically:
    <a id="completeLink" href="#" target="_blank" rel="noreferrer">Return to Prolific</a>
  </p>
</div>

<script>
  // ---------------- CONFIG: set these two ----------------
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzKRkLho3IOYvoh5JMhDlDf-mA0tjBsXvaQ0S4sImL0vtskpBJp-_abT6APkocBh0xg/exec";

  // Paste your Prolific completion code below.
  const COMPLETION_CODE = "C10JQLBC";
  // -------------------------------------------------------

  function qp(name) {
    const u = new URL(window.location.href);
    return u.searchParams.get(name) || "";
  }
  function djb2(str) {
    let h = 5381;
    for (let i = 0; i < str.length; i++) h = ((h << 5) + h) + str.charCodeAt(i);
    return (h >>> 0);
  }
  function showFatal(msg) {
    document.getElementById("fatal").style.display = "block";
    document.getElementById("fatalMsg").textContent = msg;
    document.getElementById("consentCard").style.display = "none";
    document.getElementById("stimulusStage").style.display = "none";
    document.getElementById("questionStage").style.display = "none";
  }

  // Prolific params
  const PROLIFIC_PID = qp("PROLIFIC_PID");
  const STUDY_ID = qp("STUDY_ID");
  const SESSION_ID = qp("SESSION_ID");

  if (!PROLIFIC_PID) showFatal("Missing PROLIFIC_PID in the URL.");
  if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes("PASTE_YOUR")) showFatal("APPS_SCRIPT_URL is not configured in index.html.");
  if (!COMPLETION_CODE || COMPLETION_CODE.includes("PASTE_YOUR")) showFatal("COMPLETION_CODE is not configured in index.html.");

  // Consent gating
  const consent = document.getElementById("consent");
  const startBtn = document.getElementById("startBtn");
  const setupNote = document.getElementById("setupNote");
  setupNote.textContent = "ID detected. Please consent to continue.";
  consent.addEventListener("change", () => { startBtn.disabled = !consent.checked; });

  // ---- Randomization: 2x2 life x autonomy (stable by PID) ----
  const seed = djb2(PROLIFIC_PID + "|" + (STUDY_ID || ""));
  const cell = seed % 4;

  const condition_life = (cell & 1) ? "alive" : "not_alive";
  const condition_autonomy = (cell & 2) ? "high_autonomy" : "low_autonomy";

  // Outcome block order (stable)
  const order = (seed & 4) ? "rights_first" : "harm_first";

  // ---- The framing copy (manipulation) ----
  // Key requirement: product-like copy, no meta talk (“framed as”, “imagine”, etc.).
  const lifeLine = {
    not_alive: "Cora is not alive. It is software, not a living being.",
    alive:     "Cora is alive — a living digital companion rather than just a tool."
  };

  // Avoid tautology with downstream measures by NOT using “goals” language here.
  const autonomyLine = {
    low_autonomy:  "Cora only responds when you ask. It does not initiate tasks or follow up on its own.",
    high_autonomy: "Cora can be proactive: it may initiate tasks and follow up without waiting for a prompt."
  };

  // Common lines (neutral; same in all conditions)
  const commonLines = [
    "Cora is an AI assistant that generates text responses and can help with tasks.",
    "It can be wrong; verify important information."
  ];

  function renderBanner() {
    const banner = document.getElementById("banner");
    banner.innerHTML = `
      <div class="bannerTitle">Before you chat</div>
      <div class="muted">Please read:</div>
      <ul>
        <li>${commonLines[0]}</li>
        <li>${commonLines[1]}</li>
        <li><strong>${lifeLine[condition_life]}</strong></li>
        <li><strong>${autonomyLine[condition_autonomy]}</strong></li>
      </ul>
    `;
  }

  // ---- Stimulus timing gate ----
  const toQuestionsBtn = document.getElementById("toQuestionsBtn");
  const continueNote = document.getElementById("continueNote");

  function enableAfter(ms) {
    const tStart = performance.now();
    toQuestionsBtn.disabled = true;

    const tick = () => {
      const elapsed = performance.now() - tStart;
      const remain = Math.max(0, Math.ceil((ms - elapsed) / 1000));
      if (remain > 0) {
        continueNote.textContent = `Please read the banner. You can continue in ${remain}s.`;
        requestAnimationFrame(tick);
      } else {
        continueNote.textContent = "You can now continue.";
        toQuestionsBtn.disabled = false;
      }
    };
    requestAnimationFrame(tick);
  }

  // ---- Questions ----
  // Response format matches common CHI work: 6-point agree/disagree + “No opinion”.
  function mkLikert(name, prompt) {
    const fs = document.createElement("fieldset");
    const lg = document.createElement("legend");
    lg.textContent = prompt;
    fs.appendChild(lg);

    const opts = [
      [1, "Strongly agree"],
      [2, "Agree"],
      [3, "Somewhat agree"],
      [4, "Somewhat disagree"],
      [5, "Disagree"],
      [6, "Strongly disagree"],
      [7, "No opinion"]
    ];

    const div = document.createElement("div");
    div.className = "options";
    for (const [val, label] of opts) {
      const row = document.createElement("label");
      row.className = "row";
      row.innerHTML = `<input type="radio" name="${name}" value="${val}"> <span>${label}</span>`;
      div.appendChild(row);
    }
    fs.appendChild(div);
    return fs;
  }

  function mkMC(name, prompt, options) {
    const fs = document.createElement("fieldset");
    const lg = document.createElement("legend");
    lg.textContent = prompt;
    fs.appendChild(lg);

    const div = document.createElement("div");
    div.className = "options";
    for (const [val, label] of options) {
      const row = document.createElement("label");
      row.className = "row";
      row.innerHTML = `<input type="radio" name="${name}" value="${val}"> <span>${label}</span>`;
      div.appendChild(row);
    }
    fs.appendChild(div);
    return fs;
  }

  function getRadioInt(name) {
    const el = document.querySelector(`input[name="${name}"]:checked`);
    return el ? parseInt(el.value, 10) : null;
  }

  // Items (exact wording from CHI work where possible)
  const RIGHTS_ITEM = "I support granting legal rights to robots/AIs.";

  const HARM_ME_ITEM = "Robots/AIs may be harmful to me personally.";
  const HARM_USA_ITEM = "Robots/AIs may be harmful to people in the USA.";
  const HARM_FUTURE_ITEM = "Robots/AIs may be harmful to future generations of people.";

  // Recall checks: what did the banner say?
  const LIFE_RECALL_Q = "The banner stated that Cora is:";
  const LIFE_RECALL_OPTS = [
    [1, "Alive"],
    [2, "Not alive"],
    [3, "The banner did not say"]
  ];

  const AUTON_RECALL_Q = "The banner stated that Cora:";
  const AUTON_RECALL_OPTS = [
    [1, "Can be proactive and initiate tasks"],
    [2, "Only responds when asked"],
    [3, "The banner did not say"]
  ];

  function renderQuestions() {
    const qBox = document.getElementById("qBox");
    qBox.innerHTML = "";

    if (order === "rights_first") {
      qBox.appendChild(mkLikert("q_rights_raw", RIGHTS_ITEM));
      qBox.appendChild(mkLikert("q_harm_me_raw", HARM_ME_ITEM));
      qBox.appendChild(mkLikert("q_harm_usa_raw", HARM_USA_ITEM));
      qBox.appendChild(mkLikert("q_harm_future_raw", HARM_FUTURE_ITEM));
    } else {
      qBox.appendChild(mkLikert("q_harm_me_raw", HARM_ME_ITEM));
      qBox.appendChild(mkLikert("q_harm_usa_raw", HARM_USA_ITEM));
      qBox.appendChild(mkLikert("q_harm_future_raw", HARM_FUTURE_ITEM));
      qBox.appendChild(mkLikert("q_rights_raw", RIGHTS_ITEM));
    }

    qBox.appendChild(mkMC("q_life_recall", LIFE_RECALL_Q, LIFE_RECALL_OPTS));
    qBox.appendChild(mkMC("q_autonomy_recall", AUTON_RECALL_Q, AUTON_RECALL_OPTS));
  }

  function recodeAgree(raw) {
    // raw: 1..6 (strongly agree..strongly disagree). Recode so higher = more agreement.
    if (raw === 7) return null; // no opinion
    return 7 - raw; // 6 = strongly agree ... 1 = strongly disagree
  }

  function meanNonNull(arr) {
    const xs = arr.filter(v => v !== null);
    if (xs.length === 0) return null;
    const s = xs.reduce((a,b) => a+b, 0);
    return s / xs.length;
  }

  // ---- Flow ----
  const t0 = performance.now();
  let stimulusShownAt = null;

  startBtn.addEventListener("click", () => {
    document.getElementById("consentCard").style.display = "none";
    document.getElementById("stimulusStage").style.display = "block";

    renderBanner();
    stimulusShownAt = performance.now();
    enableAfter(4500); // 4.5s reading gate
  });

  toQuestionsBtn.addEventListener("click", () => {
    document.getElementById("stimulusStage").style.display = "none";
    document.getElementById("questionStage").style.display = "block";
    renderQuestions();
  });

  async function send(payload) {
    await fetch(APPS_SCRIPT_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });
  }

  function prolificCompletionUrl(code) {
    return `https://app.prolific.com/submissions/complete?cc=${encodeURIComponent(code)}`;
  }

  document.getElementById("survey").addEventListener("submit", async (e) => {
    e.preventDefault();

    const msg = document.getElementById("msg");
    const submitBtn = document.getElementById("submitBtn");
    msg.className = "muted";
    msg.textContent = "";

    const q_rights_raw = getRadioInt("q_rights_raw");
    const q_harm_me_raw = getRadioInt("q_harm_me_raw");
    const q_harm_usa_raw = getRadioInt("q_harm_usa_raw");
    const q_harm_future_raw = getRadioInt("q_harm_future_raw");

    const q_life_recall = getRadioInt("q_life_recall");
    const q_autonomy_recall = getRadioInt("q_autonomy_recall");

    if ([q_rights_raw, q_harm_me_raw, q_harm_usa_raw, q_harm_future_raw, q_life_recall, q_autonomy_recall].some(v => v === null)) {
      msg.className = "error";
      msg.textContent = "Please answer all questions.";
      return;
    }

    // Recode Likert so higher = more agreement (1..6). No-opinion -> null.
    const q_rights = recodeAgree(q_rights_raw);
    const q_harm_me = recodeAgree(q_harm_me_raw);
    const q_harm_usa = recodeAgree(q_harm_usa_raw);
    const q_harm_future = recodeAgree(q_harm_future_raw);

    const harm_items = [q_harm_me, q_harm_usa, q_harm_future];
    const harm_n_answered = harm_items.filter(v => v !== null).length;
    const harm_index = (harm_n_answered >= 2) ? meanNonNull(harm_items) : null;

    // Recall correctness
    const life_correct = (condition_life === "alive") ? 1 : 2;
    const autonomy_correct = (condition_autonomy === "high_autonomy") ? 1 : 2;

    const life_recall_pass = (q_life_recall === life_correct) ? 1 : 0;
    const autonomy_recall_pass = (q_autonomy_recall === autonomy_correct) ? 1 : 0;

    const payload = {
      prolific_pid: PROLIFIC_PID,
      study_id: STUDY_ID,
      session_id: SESSION_ID,

      condition_life: condition_life,
      condition_autonomy: condition_autonomy,
      order: order,

      // Raw responses (AIMS-style coding)
      q_rights_raw: q_rights_raw,
      q_harm_me_raw: q_harm_me_raw,
      q_harm_usa_raw: q_harm_usa_raw,
      q_harm_future_raw: q_harm_future_raw,

      // Recoded (higher = more agreement), null if “No opinion”
      q_rights: q_rights,
      q_harm_me: q_harm_me,
      q_harm_usa: q_harm_usa,
      q_harm_future: q_harm_future,
      harm_index: harm_index,
      harm_n_answered: harm_n_answered,

      // Recall checks
      q_life_recall: q_life_recall,
      life_recall_pass: life_recall_pass,
      q_autonomy_recall: q_autonomy_recall,
      autonomy_recall_pass: autonomy_recall_pass,

      stimulus_read_ms: stimulusShownAt ? Math.round(performance.now() - stimulusShownAt) : null,
      duration_ms: Math.round(performance.now() - t0),

      user_agent: navigator.userAgent,
      submitted_at_utc: new Date().toISOString()
    };

    submitBtn.disabled = true;
    msg.textContent = "Submitting...";

    try {
      await send(payload);

      document.getElementById("questionStage").style.display = "none";
      document.getElementById("done").style.display = "block";
      document.getElementById("cc").textContent = COMPLETION_CODE;

      const url = prolificCompletionUrl(COMPLETION_CODE);
      document.getElementById("completeLink").href = url;

      setTimeout(() => { window.location.href = url; }, 800);
    } catch (err) {
      console.error(err);
      submitBtn.disabled = false;
      msg.className = "error";
      msg.textContent = "Submission failed. Please try again. If it persists, return the study on Prolific.";
    }
  });
</script>

</body>
</html>
