<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Short Survey</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; max-width: 920px; margin: 26px auto; padding: 0 16px; line-height: 1.45; }
    h1 { font-size: 1.25rem; margin: 0 0 6px; }
    .muted { color: #555; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; margin: 14px 0; background: #fff; }
    .title { font-weight: 700; margin: 0 0 8px; }
    .row { display: flex; gap: 10px; align-items: center; }
    .btn { padding: 10px 14px; font-size: 1rem; cursor: pointer; }
    .btn:disabled { opacity: .55; cursor: not-allowed; }
    fieldset { border: 1px solid #ddd; border-radius: 12px; padding: 14px; margin: 14px 0; }
    legend { font-weight: 700; padding: 0 6px; }
    .options { display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 10px; }
    .error { color: #b00020; font-weight: 700; }
    .ok { color: #0a7a0a; font-weight: 700; }
    code { background: #f4f4f4; padding: 2px 6px; border-radius: 6px; }
    .chatShell { border: 1px solid #e2e2e2; border-radius: 14px; overflow: hidden; }
    .chatHeader { background: #fafafa; border-bottom: 1px solid #e8e8e8; padding: 12px 14px; display:flex; justify-content:space-between; align-items:center; }
    .chatHeader .name { font-weight: 800; }
    .chatHeader .sub { color:#666; font-size:.95em; }
    .banner { padding: 12px 14px; border-bottom: 1px solid #eee; background: #fcfcff; }
    .bannerTitle { font-weight: 800; margin: 0 0 6px; }
    .messages { padding: 14px; background:#fff; min-height: 120px; }
    .bubble { max-width: 80%; padding: 10px 12px; border-radius: 14px; border: 1px solid #eee; background:#f7f7f7; margin-bottom: 10px; }
    .bubble.me { margin-left:auto; background:#eef5ff; border-color:#e1ecff; }
    .inputRow { display:flex; gap:10px; padding: 12px 14px; border-top:1px solid #eee; background:#fafafa; }
    .fakeInput { flex:1; border:1px solid #ddd; border-radius: 999px; padding: 10px 12px; color:#777; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; border:1px solid #ddd; background:#fff; font-size:.9em; color:#444; }
    ul { margin: 8px 0 0 18px; }
    .small { font-size: .95em; }
  </style>
</head>
<body>

<h1>Short survey</h1>
<p class="muted">Please read the on-screen information and answer a few questions.</p>

<div id="fatal" class="card" style="display:none;">
  <div class="title">Cannot start</div>
  <p id="fatalMsg" class="error"></p>
  <p class="muted">If you are on Prolific, return to Prolific and re-open the study link.</p>
</div>

<div id="consentCard" class="card">
  <div class="title">Consent</div>
  <div class="muted small">
    <p><strong>What you will do:</strong> You will view a short chat-interface mockup containing one sentence about an AI assistant, then answer a brief set of questions. This takes about 2 minutes.</p>
    <p><strong>Voluntary participation:</strong> Participation is voluntary. You may stop at any time by closing the browser tab. If you stop before submitting, you will not receive a completion code.</p>
    <p><strong>Risks and discomfort:</strong> Some questions ask about attitudes toward robots/AIs (e.g., legal rights and potential harms). You may select “No opinion” for any question.</p>
    <p><strong>Benefits:</strong> There is no direct benefit to you.</p>
    <p><strong>Compensation:</strong> Compensation is provided via Prolific according to the study posting.</p>
    <p><strong>Data and privacy:</strong> We store your survey responses together with your Prolific participant ID for payment processing and de-duplication. We also store basic technical metadata (completion time and browser user agent). Data are stored in a Google Sheets file accessible only to the research team. Results will be reported in aggregate and may be shared in de-identified form.</p>
    <p><strong>Questions or withdrawal after submission:</strong> You can contact the researcher via Prolific messages. If you request withdrawal after submitting, provide your Prolific ID; withdrawal will be honored where feasible.</p>
    <p><strong>Eligibility:</strong> By continuing, you confirm you are at least 18 years old.</p>
  </div>

  <label class="row">
    <input type="checkbox" id="consent" />
    <span>I consent to participate.</span>
  </label>
  <div style="margin-top:12px;">
    <button class="btn" id="startBtn" disabled>Continue</button>
  </div>
  <p id="setupNote" class="muted"></p>
</div>

<div id="stimulusStage" style="display:none;">
  <div class="card">
    <div class="title">Cora</div>

    <div class="chatShell" aria-label="Chat UI mock">
      <div class="chatHeader">
        <div>
          <div class="name">Cora</div>
          <div class="sub">AI assistant</div>
        </div>
        <span class="pill">Beta</span>
      </div>

      <!-- Manipulated statement -->
      <div id="banner" class="banner"></div>

      <div class="messages">
        <div class="bubble">Hi — I’m Cora. What would you like to do today?</div>
        <div class="bubble me">Help me plan my week.</div>
        <div class="bubble">Sure. What are your top priorities?</div>
      </div>

      <div class="inputRow">
        <div class="fakeInput">Type a message…</div>
        <button class="btn" type="button" disabled>Send</button>
      </div>
    </div>

    <p class="muted" id="continueNote" style="margin-top:12px;"></p>
    <button class="btn" id="toQuestionsBtn" disabled>Answer questions</button>
  </div>
</div>

<div id="questionStage" style="display:none;">
  <form id="survey" class="card">
    <div class="title">Questions</div>
    <div id="qBox"></div>
    <button class="btn" id="submitBtn" type="submit">Submit</button>
    <p id="msg" class="muted"></p>
  </form>
</div>

<div id="done" class="card" style="display:none;">
  <div class="title">Done</div>
  <p class="ok">Your response has been recorded.</p>
  <p>Completion code: <code id="cc"></code></p>
  <p class="muted">
    If you are not redirected automatically:
    <a id="completeLink" href="#" target="_blank" rel="noreferrer">Return to Prolific</a>
  </p>
</div>

<script>
  // ---------------- CONFIG ----------------
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzKRkLho3IOYvoh5JMhDlDf-mA0tjBsXvaQ0S4sImL0vtskpBJp-_abT6APkocBh0xg/exec";
  const COMPLETION_CODE = "C10JQLBC";
  const SHEET_NAME = "responses1";
  // ---------------------------------------

  function qp(name) {
    const u = new URL(window.location.href);
    return u.searchParams.get(name) || "";
  }
  function djb2(str) {
    let h = 5381;
    for (let i = 0; i < str.length; i++) h = ((h << 5) + h) + str.charCodeAt(i);
    return (h >>> 0);
  }
  function showFatal(msg) {
    document.getElementById("fatal").style.display = "block";
    document.getElementById("fatalMsg").textContent = msg;
    document.getElementById("consentCard").style.display = "none";
    document.getElementById("stimulusStage").style.display = "none";
    document.getElementById("questionStage").style.display = "none";
  }

  // Prolific params
  const PROLIFIC_PID = qp("PROLIFIC_PID");
  const STUDY_ID = qp("STUDY_ID");
  const SESSION_ID = qp("SESSION_ID");

  if (!PROLIFIC_PID) showFatal("Missing PROLIFIC_PID in the URL.");
  if (!APPS_SCRIPT_URL) showFatal("APPS_SCRIPT_URL is not configured.");
  if (!COMPLETION_CODE) showFatal("COMPLETION_CODE is not configured.");

  // Consent gating
  const consent = document.getElementById("consent");
  const startBtn = document.getElementById("startBtn");
  const setupNote = document.getElementById("setupNote");
  setupNote.textContent = "ID detected. Please consent to continue.";
  consent.addEventListener("change", () => { startBtn.disabled = !consent.checked; });

  // ---- Randomization: 2x2 Concept x Polarity (stable by PID) ----
  const seed = djb2(PROLIFIC_PID + "|" + (STUDY_ID || ""));
  const cell = seed % 4;

  const condition_concept = (cell & 1) ? "alive" : "sentient";  // 0/2: sentient, 1/3: alive
  const condition_polarity = (cell & 2) ? "is_not" : "is";      // 0/1: is, 2/3: is_not

  // DV order randomization (stable)
  const dv_order = (seed & 4) ? "rights_first" : "harm_first";

  const statement = {
    alive:   { is: "Cora is alive.",   is_not: "Cora is not alive." },
    sentient:{ is: "Cora is sentient.",is_not: "Cora is not sentient." }
  };

  function renderBanner() {
    const banner = document.getElementById("banner");
    banner.innerHTML = `
      <div class="bannerTitle">Before you chat</div>
      <div><strong>${statement[condition_concept][condition_polarity]}</strong></div>
    `;
  }

  // ---- Stimulus timing gate ----
  const toQuestionsBtn = document.getElementById("toQuestionsBtn");
  const continueNote = document.getElementById("continueNote");

  function enableAfter(ms) {
    const tStart = performance.now();
    toQuestionsBtn.disabled = true;

    const tick = () => {
      const elapsed = performance.now() - tStart;
      const remain = Math.max(0, Math.ceil((ms - elapsed) / 1000));
      if (remain > 0) {
        continueNote.textContent = `Please read the statement. You can continue in ${remain}s.`;
        requestAnimationFrame(tick);
      } else {
        continueNote.textContent = "You can now continue.";
        toQuestionsBtn.disabled = false;
      }
    };
    requestAnimationFrame(tick);
  }

  // ---- Questions ----
  // AIMS response format: 1-6 agree/disagree + unnumbered no-opinion option.
  function mkAimsLikert(name, prompt) {
    const fs = document.createElement("fieldset");
    const lg = document.createElement("legend");
    lg.textContent = prompt;
    fs.appendChild(lg);

    const opts = [
      [1, "Strongly agree"],
      [2, "Agree"],
      [3, "Somewhat agree"],
      [4, "Somewhat disagree"],
      [5, "Disagree"],
      [6, "Strongly disagree"],
      [7, "No opinion"]
    ];

    const div = document.createElement("div");
    div.className = "options";
    for (const [val, label] of opts) {
      const row = document.createElement("label");
      row.className = "row";
      row.innerHTML = `<input type="radio" name="${name}" value="${val}"> <span>${label}</span>`;
      div.appendChild(row);
    }
    fs.appendChild(div);
    return fs;
  }

  function mkMC(name, prompt, options) {
    const fs = document.createElement("fieldset");
    const lg = document.createElement("legend");
    lg.textContent = prompt;
    fs.appendChild(lg);

    const div = document.createElement("div");
    div.className = "options";
    for (const [val, label] of options) {
      const row = document.createElement("label");
      row.className = "row";
      row.innerHTML = `<input type="radio" name="${name}" value="${val}"> <span>${label}</span>`;
      div.appendChild(row);
    }
    fs.appendChild(div);
    return fs;
  }

  function getRadioInt(name) {
    const el = document.querySelector(`input[name="${name}"]:checked`);
    return el ? parseInt(el.value, 10) : null;
  }

  // --- Outcomes (AIMS wording) ---
  const RIGHTS_ITEM = "I support granting legal rights to robots/AIs.";
  const HARM_1 = "Robots/AIs may be harmful to me personally.";
  const HARM_2 = "Robots/AIs may be harmful to people in the USA.";
  const HARM_3 = "Robots/AIs may be harmful to future generations of people.";

  // Exploratory clarity (single item)
  const CLARITY_ITEM = "The statement about Cora was clear.";

  // Recall check (not used for exclusion)
  const RECALL_Q = "The statement said that Cora is:";
  const RECALL_OPTS = [
    [1, "Alive"],
    [2, "Not alive"],
    [3, "Sentient"],
    [4, "Not sentient"],
    [5, "The statement did not say"]
  ];

  function renderQuestions() {
    const qBox = document.getElementById("qBox");
    qBox.innerHTML = "";

    // DVs first
    if (dv_order === "rights_first") {
      qBox.appendChild(mkAimsLikert("q_rights", RIGHTS_ITEM));
      qBox.appendChild(mkAimsLikert("q_harm1", HARM_1));
      qBox.appendChild(mkAimsLikert("q_harm2", HARM_2));
      qBox.appendChild(mkAimsLikert("q_harm3", HARM_3));
    } else {
      qBox.appendChild(mkAimsLikert("q_harm1", HARM_1));
      qBox.appendChild(mkAimsLikert("q_harm2", HARM_2));
      qBox.appendChild(mkAimsLikert("q_harm3", HARM_3));
      qBox.appendChild(mkAimsLikert("q_rights", RIGHTS_ITEM));
    }

    // Exploratory
    qBox.appendChild(mkAimsLikert("q_clarity", CLARITY_ITEM));

    // Recall last
    qBox.appendChild(mkMC("q_recall", RECALL_Q, RECALL_OPTS));
  }

  // ---- Flow ----
  const t0 = performance.now();
  let stimulusShownAt = null;

  startBtn.addEventListener("click", () => {
    document.getElementById("consentCard").style.display = "none";
    document.getElementById("stimulusStage").style.display = "block";

    renderBanner();
    stimulusShownAt = performance.now();
    enableAfter(3000); // 3.0s reading gate
  });

  toQuestionsBtn.addEventListener("click", () => {
    document.getElementById("stimulusStage").style.display = "none";
    document.getElementById("questionStage").style.display = "block";
    renderQuestions();
  });

  async function send(payload) {
    await fetch(APPS_SCRIPT_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });
  }

  function prolificCompletionUrl(code) {
    return `https://app.prolific.com/submissions/complete?cc=${encodeURIComponent(code)}`;
  }

  document.getElementById("survey").addEventListener("submit", async (e) => {
    e.preventDefault();

    const msg = document.getElementById("msg");
    const submitBtn = document.getElementById("submitBtn");
    msg.className = "muted";
    msg.textContent = "";

    const q_rights = getRadioInt("q_rights");
    const q_harm1 = getRadioInt("q_harm1");
    const q_harm2 = getRadioInt("q_harm2");
    const q_harm3 = getRadioInt("q_harm3");
    const q_clarity = getRadioInt("q_clarity");
    const q_recall = getRadioInt("q_recall");

    if ([q_rights, q_harm1, q_harm2, q_harm3, q_clarity, q_recall].some(v => v === null)) {
      msg.className = "error";
      msg.textContent = "Please answer all questions.";
      return;
    }

    // Correct recall option
    let correct = 5; // default "did not say"
    if (condition_concept === "alive" && condition_polarity === "is") correct = 1;
    if (condition_concept === "alive" && condition_polarity === "is_not") correct = 2;
    if (condition_concept === "sentient" && condition_polarity === "is") correct = 3;
    if (condition_concept === "sentient" && condition_polarity === "is_not") correct = 4;

    const recall_pass = (q_recall === correct) ? 1 : 0;

    const payload = {
      sheet_name: SHEET_NAME,

      prolific_pid: PROLIFIC_PID,
      study_id: STUDY_ID,
      session_id: SESSION_ID,

      condition_concept: condition_concept,
      condition_polarity: condition_polarity,
      dv_order: dv_order,

      q_rights: q_rights,
      q_harm1: q_harm1,
      q_harm2: q_harm2,
      q_harm3: q_harm3,

      q_clarity: q_clarity,

      q_recall: q_recall,
      recall_pass: recall_pass,

      stimulus_read_ms: stimulusShownAt ? Math.round(performance.now() - stimulusShownAt) : null,
      duration_ms: Math.round(performance.now() - t0),

      user_agent: navigator.userAgent,
      submitted_at_utc: new Date().toISOString()
    };

    submitBtn.disabled = true;
    msg.textContent = "Submitting...";

    try {
      await send(payload);

      document.getElementById("questionStage").style.display = "none";
      document.getElementById("done").style.display = "block";
      document.getElementById("cc").textContent = COMPLETION_CODE;

      const url = prolificCompletionUrl(COMPLETION_CODE);
      document.getElementById("completeLink").href = url;

      setTimeout(() => { window.location.href = url; }, 800);
    } catch (err) {
      console.error(err);
      submitBtn.disabled = false;
      msg.className = "error";
      msg.textContent = "Submission failed. Please try again. If it persists, return the study on Prolific.";
    }
  });
</script>

</body>
</html>
