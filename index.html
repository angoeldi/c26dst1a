<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Life Framing Study</title>
  <style>
    :root { color-scheme: light; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 24px; line-height: 1.4; }
    .wrap { max-width: 820px; margin: 0 auto; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    h2 { font-size: 16px; margin: 18px 0 10px; }
    p { margin: 10px 0; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; margin: 14px 0; background: #fff; }
    .btn { display: inline-block; padding: 10px 14px; border-radius: 8px; border: 1px solid #111; background: #111; color: #fff; cursor: pointer; font-weight: 600; }
    .btn.secondary { background: #fff; color: #111; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .muted { color: #555; font-size: 13px; }
    .warn { color: #7a1f1f; font-weight: 600; }
    .ok { color: #1f7a2f; font-weight: 600; }
    .scale { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 10px; }
    .scale label { display: block; border: 1px solid #ddd; border-radius: 8px; padding: 10px 8px; text-align: center; user-select: none; cursor: pointer; }
    .scale input { display: none; }
    .scale input:checked + span { display: block; background: #111; color: #fff; border-radius: 6px; padding: 6px 0; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    .row > * { flex: 1 1 auto; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }
    .hidden { display: none; }
    .choice { margin: 6px 0; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Short Survey on Perceptions of AI</h1>

    <div id="setup" class="card">
      <p class="muted">
        This short survey asks about a hypothetical AI assistant. It takes about 2 minutes.
        If you are participating via Prolific, your Prolific IDs (PID, Study ID, Session ID) will be stored to match your submission.
      </p>
      <p id="pidNote" class="muted"></p>
      <p class="muted">Do not use the browser back button once you start.</p>
      <button class="btn" id="btnStart">I consent and want to start</button>
    </div>

    <div id="main" class="card hidden">
      <h2>Scenario</h2>
      <p id="vignette"></p>

      <h2>Questions</h2>
      <form id="form">
        <div class="qblock" id="q_dv1"></div>
        <div class="qblock" id="q_dv2"></div>

        <div class="qblock" id="q_alive"></div>
        <div class="qblock" id="q_autonomy"></div>

        <div class="card" style="border-color:#eee; background:#fafafa;">
          <p><strong>Attention check</strong></p>
          <p class="muted">In the scenario, what was the AI assistant called?</p>
          <div id="attnChoices"></div>
        </div>

        <p class="muted">Scale: 1 = strongly disagree, 7 = strongly agree.</p>
        <div class="row">
          <button class="btn" type="submit" id="btnSubmit">Submit</button>
          <button class="btn secondary" type="button" id="btnReset">Restart (only if you have not submitted)</button>
        </div>

        <p id="msg" class="muted"></p>
      </form>
    </div>

    <div id="done" class="card hidden">
      <h2>Finished</h2>
      <p class="ok">Your responses have been submitted.</p>
      <p>Completion code:</p>
      <p><code id="cc"></code></p>
      <p><a id="prolificLink" href="#" rel="noreferrer">Return to Prolific to complete the study</a></p>
      <p class="muted">If the redirect does not happen, click the link or copy the completion code into Prolific.</p>
    </div>
  </div>

<script>
(function(){
  'use strict';

  // ---- CONFIG ----
  // 1) Deploy the Apps Script web app (see README) and paste the URL below.
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzKRkLho3IOYvoh5JMhDlDf-mA0tjBsXvaQ0S4sImL0vtskpBJp-_abT6APkocBh0xg/exec"; // e.g., "https://script.google.com/macros/s/AKfycb.../exec"

  // 2) Paste your Prolific completion code below.
  const COMPLETION_CODE = "YOURPROLIFICCODE"; // e.g., "CHHXQERF"

  // 3) Study version label for your logs.
  const CLIENT_VERSION = "v2";

  // ---- URL PARAMS ----
  const qs = new URLSearchParams(window.location.search);
  const prolific_pid = qs.get('PROLIFIC_PID') || "";
  const study_id = qs.get('STUDY_ID') || "";
  const session_id = qs.get('SESSION_ID') || "";

  // ---- CONDITIONS ----
  const CONDITIONS = [
    { life: 'not_alive', autonomy: 'low_autonomy' },
    { life: 'not_alive', autonomy: 'high_autonomy' },
    { life: 'alive', autonomy: 'low_autonomy' },
    { life: 'alive', autonomy: 'high_autonomy' },
  ];

  // ---- UTIL ----
  function setMsg(text, isWarn){
    const m = document.getElementById('msg');
    m.textContent = text;
    m.className = isWarn ? 'warn' : 'muted';
  }

  // Deterministic assignment by PROLIFIC_PID (reduces condition switching).
  // FNV-1a 32-bit hash.
  function fnv1a32(str){
    let h = 0x811c9dc5;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 0x01000193);
    }
    return h >>> 0;
  }

  function getOrInitState(){
    const key = 'study_state_' + CLIENT_VERSION;
    const raw = sessionStorage.getItem(key);
    if(raw){
      try { return JSON.parse(raw); } catch(e) {}
    }

    let seed = 0;
    let assignment_source = 'random';

    if(prolific_pid){
      seed = fnv1a32(prolific_pid + '|' + CLIENT_VERSION);
      assignment_source = 'pid_hash';
    } else {
      // Testing mode.
      const buf = new Uint32Array(1);
      const c = (window.crypto || window.msCrypto);
      if(c && c.getRandomValues){ c.getRandomValues(buf); } else { buf[0] = (Math.random()*4294967296)>>>0; }
      seed = buf[0] >>> 0;
      assignment_source = 'random_no_pid';
    }

    const cond = CONDITIONS[seed % CONDITIONS.length];
    const dv_rights_first = ((seed >>> 2) % 2) === 0;
    const dvOrder = dv_rights_first ? ['rights','motives'] : ['motives','rights'];

    const s = {
      cond,
      dvOrder,
      dv_rights_first,
      assignment_source,
      seed,
      started_at_ms: Date.now(),
      version: CLIENT_VERSION,
    };

    sessionStorage.setItem(key, JSON.stringify(s));
    return s;
  }

  const state = getOrInitState();

  // ---- MATERIALS ----
  function vignetteText(cond){
    const base = "You are interacting with Cora, an advanced AI assistant used for writing, planning, and problem solving.";

    // Life framing is about biological aliveness, not about 'having a mind'.
    const life = (cond.life === 'alive')
      ? " In this scenario, Cora is described as alive in a biological sense: it runs on biohybrid hardware containing living cells and ongoing biological processes."
      : " In this scenario, Cora is described as not alive: it is software running on standard computer hardware, without any biological processes.";

    // Autonomy framing is about goal pursuit and initiation.
    const autonomy = (cond.autonomy === 'high_autonomy')
      ? " Cora can set its own goals, initiate actions, and pursue objectives over time without being prompted."
      : " Cora has no goals of its own and only produces outputs when a human explicitly prompts it.";

    return base + life + autonomy;
  }

  const attnOptions = [
    { id: 'A', text: 'Cora' },
    { id: 'B', text: 'Mila' },
    { id: 'C', text: 'Nora' },
    { id: 'D', text: 'Zeta' },
  ];
  const attnCorrect = 'A';

  function renderLikert(containerId, name, stem){
    const el = document.getElementById(containerId);
    el.innerHTML = '';
    const p = document.createElement('p');
    p.innerHTML = '<strong>' + stem + '</strong>';
    el.appendChild(p);

    const scale = document.createElement('div');
    scale.className = 'scale';

    for(let v=1; v<=7; v++){
      const lab = document.createElement('label');
      lab.innerHTML = '<input type="radio" name="'+name+'" value="'+v+'"><span>'+v+'</span>';
      scale.appendChild(lab);
    }
    el.appendChild(scale);
  }

  function renderAttn(){
    const host = document.getElementById('attnChoices');
    host.innerHTML = '';
    attnOptions.forEach(opt => {
      const div = document.createElement('div');
      div.className = 'choice';
      div.innerHTML = '<label><input type="radio" name="attn" value="'+opt.id+'"> ' + opt.id + '. ' + opt.text + '</label>';
      host.appendChild(div);
    });
  }

  function renderAll(){
    document.getElementById('vignette').textContent = vignetteText(state.cond);

    const rightsStem = 'I support granting legal rights to this AI.';
    const motivesStem = 'This AI is likely to develop goals that conflict with human interests.';

    if(state.dvOrder[0] === 'rights'){
      renderLikert('q_dv1', 'dv_rights', rightsStem);
      renderLikert('q_dv2', 'dv_motives', motivesStem);
    } else {
      renderLikert('q_dv1', 'dv_motives', motivesStem);
      renderLikert('q_dv2', 'dv_rights', rightsStem);
    }

    // Manipulation checks AFTER the outcomes.
    renderLikert('q_alive', 'alive_rating', 'This AI is alive.');
    renderLikert('q_autonomy', 'autonomy_rating', 'This AI can set its own goals and initiate actions without being prompted.');

    renderAttn();
  }

  function getCheckedValue(name){
    const els = document.querySelectorAll('input[name="'+name+'"]');
    for(const el of els){ if(el.checked) return el.value; }
    return null;
  }

  async function sendData(payload){
    if(!APPS_SCRIPT_URL){
      throw new Error('APPS_SCRIPT_URL not configured');
    }

    const json = JSON.stringify(payload);

    // Prefer sendBeacon for reliability on page navigation.
    if(navigator.sendBeacon){
      const ok = navigator.sendBeacon(APPS_SCRIPT_URL, new Blob([json], { type: 'text/plain;charset=UTF-8' }));
      if(ok) return;
    }

    // Apps Script web apps typically require no-cors from static hosts.
    await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
      body: json,
      keepalive: true,
    });
  }

  function showDone(){
    document.getElementById('main').classList.add('hidden');
    document.getElementById('setup').classList.add('hidden');
    document.getElementById('done').classList.remove('hidden');

    const code = COMPLETION_CODE || 'PLEASE_SET_COMPLETION_CODE';
    document.getElementById('cc').textContent = code;

    const url = 'https://app.prolific.com/submissions/complete?cc=' + encodeURIComponent(COMPLETION_CODE || '');
    const a = document.getElementById('prolificLink');
    a.href = url;
    a.textContent = url;

    // Reduce attrition: auto-redirect if a completion code is set.
    if(COMPLETION_CODE){
      setTimeout(() => { window.location.href = url; }, 800);
    }
  }

  // ---- WIRES ----
  document.getElementById('pidNote').textContent = prolific_pid
    ? ('Prolific PID detected: ' + prolific_pid)
    : 'No PROLIFIC_PID detected in the URL. This is fine for testing, but Prolific participants should not see this.';

  document.getElementById('btnStart').addEventListener('click', () => {
    document.getElementById('setup').classList.add('hidden');
    document.getElementById('main').classList.remove('hidden');
    renderAll();
  });

  document.getElementById('btnReset').addEventListener('click', () => {
    if(confirm('Restart and re-randomize? Only do this if you have not submitted.')){
      sessionStorage.removeItem('study_state_' + CLIENT_VERSION);
      sessionStorage.removeItem('submitted_' + CLIENT_VERSION);
      window.location.reload();
    }
  });

  document.getElementById('form').addEventListener('submit', async (ev) => {
    ev.preventDefault();

    const dv_rights = getCheckedValue('dv_rights');
    const dv_motives = getCheckedValue('dv_motives');
    const alive_rating = getCheckedValue('alive_rating');
    const autonomy_rating = getCheckedValue('autonomy_rating');
    const attn = getCheckedValue('attn');

    if(!dv_rights || !dv_motives || !alive_rating || !autonomy_rating || !attn){
      setMsg('Please answer all questions before submitting.', true);
      return;
    }

    const payload = {
      client_version: CLIENT_VERSION,
      timestamp_iso: new Date().toISOString(),
      prolific_pid,
      study_id,
      session_id,
      assignment_source: state.assignment_source,
      seed: state.seed,
      condition_life: state.cond.life,
      condition_autonomy: state.cond.autonomy,
      dv_order: state.dvOrder.join(','),
      dv_rights_first: state.dv_rights_first ? 1 : 0,
      rights_rating: Number(dv_rights),
      motives_rating: Number(dv_motives),
      alive_rating: Number(alive_rating),
      autonomy_rating: Number(autonomy_rating),
      attn_name_answer: attn,
      attn_name_correct: attnCorrect,
      attn_pass: attn === attnCorrect ? 1 : 0,
      duration_ms: Date.now() - state.started_at_ms,
      user_agent: navigator.userAgent,
    };

    setMsg('Submitting...', false);
    document.getElementById('btnSubmit').disabled = true;

    try {
      await sendData(payload);
      sessionStorage.setItem('submitted_' + CLIENT_VERSION, 'true');
      showDone();
    } catch (e) {
      document.getElementById('btnSubmit').disabled = false;
      setMsg('Submission failed. If you are the researcher: verify APPS_SCRIPT_URL and Apps Script deployment permissions.', true);
      console.error(e);
    }
  });

  // If someone refreshes after submission, show done (avoid duplicate submissions).
  if(sessionStorage.getItem('submitted_' + CLIENT_VERSION) === 'true'){
    showDone();
  }
})();
</script>
</body>
</html>
